<html>
<body>
test dupes
test overlapping promos
test condition same as mod id
test dupe conditions

<script type="text/javascript">

// making assumption in the event of a combo purchase, the items are not sharable to other combos
// making assumption that items purchased with promotion can not have more then one promotion applied
// making assumption to apply the most cost effective promotion for the customer
// making assumption that overlaping promotions are intentional or acceptable


let cart = [1001,1004,1003,1002,1004,1006,1004,1001,1004,1004,6732,4900,1111];

// new scheme
let newitems = [
	{_id:0,items:[6732,4900],name:'chips and salsa combo',price:-.99,tax:0},
	{_id:1,items:[1001],name:'eggs',price:1.99,tax:.06},
	{_id:2,items:[1004],name:'toothbrush',price:1.99,tax:.06},
	{_id:3,items:[1004,1004],name:'toothbrushes',price:-1.99,tax:.06},
	{_id:4,items:[1003],name:'bread',price:3.99,tax:.06},
	{_id:5,items:[1002],name:'milk',price:6.99,tax:.06},
	{_id:12,items:[6732,4900],name:'chips and salsa combo',price:-1.99,tax:0},
	{_id:6,items:[1005],name:'soda',price:5.99,tax:.06},
	{_id:7,items:[1006],name:'wine',price:9.99,tax:.0925},
	{_id:8,items:[1007],name:'apples',price:1.00,tax:.06},
	{_id:9,items:[6732],name:'chips',price:2.49,tax:0},
	{_id:10,items:[4900],name:'salsa',price:3.49,tax:0},
	{_id:11,items:[6732,4900],name:'chips and salsa combo',price:-2.99,tax:0},

];

// float
var total = 0;
function processCart(){
	// store available remaining matches to ensure no erroneous duplication of shared partials in combos
	let available;
	// for each item in cart
	for (let i = cart.length - 1; i >= 0; i--) {

		try{
			// apply tax and add items price to subtotal
			let item = newitems.find(entry => entry.items.length === 1 && entry.items[0] === cart[i]);
			total += (item.price * (1+item.tax));
		}catch(err){
			console.log('item code not found');
			continue;
		}

		// filter modifiers to just those relevant to this cart item
		let relevantModifiers = newitems.filter(function(entry){ return entry.items.length > 1 && entry.items.includes(cart[i]); });
		// sort promotions by cost savings in the event of duplicate/overlapping promos
		relevantModifiers.sort((a, b) => a.price - b.price);

		// for each relevant modifier try to apply modifiers allowing it to fail when unmet
		for(let found of relevantModifiers){
			try{
				// use set to verify met conditions are of unique indexes in cart
				let valid = new Set();
				for (let j = found.items.length - 1; j >= 0; j--) {
					// create scoped clone of cart array to remove used indexes from
					let arr = cart.slice();
					// apply current items availability if prior promotions have been applied to cart
					if(available){
						// replace arr with clone of available remaining matches to ensure no erroneous duplication of shared partials in combos
						arr = available.slice();
					}
					
					// get index of condition item _id
					let test = arr.indexOf(found.items[j]);
					// if not the current cart item, and item exists in cart increment count of conditions met
					if(test !== -1){
						// mutate scoped cart arr but maintains index
						delete arr[test];
						// add to valid indexes
						valid.add(test);
						// add to temp store remaining unused items
						available = arr.slice();

					}
				}
				// verify all nessesary conditions are met
				if(valid.size === found.items.length){
					// log modifier with all conditions validated
					console.log(found);
					// remove this item as it has received modification
					//delete available[cart[i]][i]; // not after removal of remaining arr delete this

					// apply modifier to total
					total+= found.price;
				}
			}catch(err){
				console.log('err');
			}
		}
	}
}

var t0 = performance.now();
processCart();
var t1 = performance.now();
console.log("Call to processCart took " + (t1 - t0) + " milliseconds.");
console.log(Math.round(total*100)/100);
</script>
</body>
</html>